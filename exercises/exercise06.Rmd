---
title: "Exercise 6"
author: "Philipp Drebes"
date: "`r format(Sys.Date(), '%d.%m.%Y')`"
output:
  pdf_document:
    keep_tex: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Exercise 6.1

We visit the analysis of the yield of a chemical process and will have a look at the <http://stat.ethz.ch/Teaching/Datasets/WBL/yields.dat> time series and its autocorrelations.

```{r}
library(forecast)
yields <- read.table("http://stat.ethz.ch/Teaching/Datasets/WBL/yields.dat", header = FALSE)
t.yields <- ts(yields[, 1])
```

a)  Could these data be generated by an AR-process? If yes, what is the order p?

```{r}
tsdisplay(t.yields)
```

\textcolor{blue}{It could be an AR(p) process as the ACF has an exponential decay. The PACF has no significant values after lag 1, so we assume $p=1$.}

b)  Using the autocorrelations, compute the Yule-Walker estimate of $\alpha$ by hand.\
    Recall the Yule-Walker equation for the estimated autocorrelation function at lag 1 reads: $$\hat{p}(1) = \alpha \cdot \hat{p}(0)$$

Furthermore, find the estimated mean $\hat{\mu}_X$ as well as the innovation variance $\hat{\sigma}^2$.

Check your results using R.

```{r}
r.yw <- ar(t.yields, method = "yw", order.max = 1)
str(r.yw)
tsdisplay(r.yw$resid)
```

\textcolor{blue}{$\alpha$ is estimated at $\alpha =-0.39$.}

c)  Use the Burg method to compute the parameters of the AR model. Check its residuals.

```{r}
r.burg <- ar(t.yields, method = "burg", order.max = 1)
str(r.burg)
tsdisplay(r.burg$resid)
```

\textcolor{blue}{The autocorrelations of the residuals lie inside the confidence band. The residuals are stationary. $\alpha$ is estimated at $\alpha =-0.407$.}

d)  Use Maximum Likelihood to estimate these parameters.

```{r}
r.mle <- ar(t.yields, method = "mle", order.max = 1)
str(r.mle)
tsdisplay(r.mle$resid)
```

\textcolor{blue}{The autocorrelations of the residuals lie inside the confidence band. The residuals are stationary. $\alpha$ is estimated at $\alpha =-0.419$.}

## Exercise 6.2

In this exercise we examine measurements of the vertical force acting on a cylinder in a water tank. A total of 320 measurements were taken at intervals of 0.15 seconds. Load the data from <http://stat.ethz.ch/Teaching/Datasets/WBL/kraft.dat> and convert them to a time series.

```{r}
d.force <- read.table("http://stat.ethz.ch/Teaching/Datasets/WBL/kraft.dat", header = FALSE)
ts.force <- ts(d.force[, 1])
```

It is already known that at the time of the experiment, the water in the tank formed waves with (randomly changing) periods of around 2 seconds.

a)  Create a subset of the data containing only the first 280 observations.

```{r}
ts.forceA <- window(ts.force, end = 280)
```

Is a periodic behavior to be expected in these data? If so, what should the period be? Does the plot of the times series agree with your expectations?

\textcolor{blue}{Yes, a periodic behavior is expected, as the water in the tank forms waves. It is expected that the pressure on the cylinder increases and decreases with the pattern of the waves.}

```{r}
plot(ts.forceA)
```

b)  Suppose you would like to fit the time series ts.forceA by an AR(p) model.\
    Which order p should this model have? Choose a suitable order once by looking at the partial autocorrelations, and once by using the Akaike information criterion (AIC).

```{r}
tsdisplay(ts.forceA)

ar.force <- ar(ts.forceA, method = 'mle')
plot(ar.force$aic, type = 'l')
```

\textcolor{blue}{The PACF has no significant values after a lag of 6. We could assume that this is the order of the AR(p) process. In the AIC with the method MLE we observe the lowest value at lag 7. When fitting a model in step c) we will therefore compare the models with $p=6$ and $p=7$ and then decide which one has the better fit.}

c)  Fit an AR(p) model using maximum likelihood for the time series ts.forceA, where p is the order specified in Part b). Analyze the residuals. Is the model appropriate for this time series?

```{r}
ar.force.6 <- arima(ts.forceA, order = c(6, 0, 0), method = 'ML')
ar.force.7 <- arima(ts.forceA, order = c(7, 0, 0), method = 'ML')

tsdisplay(ar.force.6$residuals)
tsdisplay(ar.force.7$residuals)
```

\textcolor{blue}{Just by comparing the residuals of the models fit with order 6 vs order 7, we cannot clearly conclude which model has the more optimal fit.}

```{r}
par(mfrow=c(1,2))
qqnorm(ar.force.6$residuals, main='Normal Q-Q Plot: AR(6)')
qqline(ar.force.6$residuals)

qqnorm(ar.force.7$residuals, main='Normal Q-Q Plot: AR(7)')
qqline(ar.force.7$residuals)
```

\textcolor{blue}{The model of order 7 does appear to fit a little better as the dots in the upper right corder of the Q-Q plot align a little better with the line. However, the difference between order 6 and 7 is miniscule. Going forward we will now use the model with order 7.}

d)  Use the model fitted in Part c) to compute point predictions and prediction intervals for the next 40 measurements. Compare these graphically to the actual measurements.\
    Then, plot the point predictions and the confidence intervals into the plot.

```{r}
force.pred <- predict(ar.force.7, n.ahead = 40)
plot(window(ts.force, start = 250))
lines(force.pred$pred, col = 'red', type = 'p', pch = 18)
lines(force.pred$pred + 1.96 * force.pred$se, col = 'blue', lty = 2)
lines(force.pred$pred - 1.96 * force.pred$se, col = 'blue', lty = 2)
```

\textcolor{blue}{The predicted values are relatively close to the actual measurements. Depending on the actual use-case, this could be considered a usable fit. It could be however argued, that the confidence interval is quite wide and predictions are to be interpreted with caution.}
